<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>获取iOS设备唯一标示UUID (转发来源简书) | Jason</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/app.css">
  <!-- <link rel='stylesheet' href='http://fonts.useso.com/css?family=Source+Code+Pro'> -->
  
</head>

<body>
  <nav class="app-nav">
  
    
      <a href="/.">home</a>
    
  
    
      <a href="/archives">archive</a>
    
  
</nav>

  <main class="post">
  <article>
  <h1 class="article-title">
    <a href="/2017/04/21/获取iOS设备唯一标示UUID (转发)/">获取iOS设备唯一标示UUID (转发来源简书)</a>
  </h1>

  <section class="article-meta">
    <p class="article-date">April 21 2017</p>
  </section>

  <section class="article-entry">
    <p>在开发过程中，我们经常会被要求获取每个设备的唯一标示，以便后台做相应的处理。我们来看看有哪些方法来获取设备的唯一标示，然后再分析下这些方法的利弊。</p>
<p>具体可以分为如下几种：</p>
<ol>
<li>UDID</li>
<li>IDFA</li>
<li>IDFV</li>
<li>MAC</li>
<li>keychain</li>
</ol>
<hr>
<p>下面我们来具体分析下每种获取方法的利弊</p>
<h3 id="1、UDID"><a href="#1、UDID" class="headerlink" title="1、UDID"></a>1、UDID</h3><p>什么是UDID</p>
<p>UDID 「Unique Device Identifier Description」是由子母和数字组成的40个字符串的序号，用来区别每一个唯一的iOS设备，包括 iPhones, iPads, 以及 iPod touches，这些编码看起来是随机的，实际上是跟硬件设备特点相联系的，另外你可以到iTunes，pp助手或itools等软件查看你的udid（设备标识）</p>
<p>UDID是用来干什么的？</p>
<p>UDID可以关联其它各种数据到相关设备上。例如，连接到开发者账号，可以允许在发布前让设备安装或测试应用；也可以让开发者获得iOS测试版进行体验。苹果用UDID连接到苹果的ID，这些设备可以自动下载和安装从App Store购买的应用、保存从iTunes购买的音乐、帮助苹果发送推送通知、即时消息。 在iOS 应用早期，UDID被第三方应用开发者和网络广告商用来收集用户数据，可以用来关联地址、记录应用使用习惯……以便推送精准广告。</p>
<p>为什么苹果反对开发人员使用UDID？</p>
<p>iOS 2.0版本以后UIDevice提供一个获取设备唯一标识符的方法uniqueIdentifier，通过该方法我们可以获取设备的序列号，这个也是目前为止唯一可以确认唯一的标示符。 许多开发者把UDID跟用户的真实姓名、密码、住址、其它数据关联起来；网络窥探者会从多个应用收集这些数据，然后顺藤摸瓜得到这个人的许多隐私数据。同时大部分应用确实在频繁传输UDID和私人信息。 为了避免集体诉讼，苹果最终决定在iOS 5 的时候，将这一惯例废除，开发者被引导生成一个唯一的标识符，只能检测应用程序，其他的信息不提供。现在应用试图获取UDID已被禁止且不允许上架。</p>
<p>所以这个方法作废</p>
<h3 id="2、IDFA"><a href="#2、IDFA" class="headerlink" title="2、IDFA"></a>2、IDFA</h3><p>全名：advertisingIdentifier</p>
<p>获取代码：<br><code>#import &lt;AdSupport/AdSupport.h&gt;
  NSString *adId = [[[ASIdentifierManager sharedManager] advertisingIdentifier] UUIDString];</code><br>来源：iOS6.0及以后</p>
<p>说明：直译就是广告id， 在同一个设备上的所有App都会取到相同的值，是苹果专门给各广告提供商用来追踪用户而设的，用户可以在 设置|隐私|广告追踪 里重置此id的值，或限制此id的使用，故此id有可能会取不到值，但好在Apple默认是允许追踪的，而且一般用户都不知道有这么个设置，所以基本上用来监测推广效果，是戳戳有余了。</p>
<p>注意：由于idfa会出现取不到的情况，故绝不可以作为业务分析的主id，来识别用户。</p>
<h3 id="3、IDFV"><a href="#3、IDFV" class="headerlink" title="3、IDFV"></a>3、IDFV</h3><p>全名：identifierForVendor<br>获取代码：<br><code>NSString *idfv = [[[UIDevice currentDevice] identifierForVendor] UUIDString];</code><br>来源：iOS6.0及以后</p>
<p>说明：顾名思义，是给Vendor标识用户用的，每个设备在所属同一个Vender的应用里，都有相同的值。其中的Vender是指应用提供商，但准确点说，是通过BundleID的反转的前两部分进行匹配，如果相同就是同一个Vender，例如对于com.taobao.app1, com.taobao.app2 这两个BundleID来说，就属于同一个Vender，共享同一个idfv的值。和idfa不同的是，idfv的值是一定能取到的，所以非常适合于作为内部用户行为分析的主id，来标识用户，替代OpenUDID。</p>
<p>注意：如果用户将属于此Vender的所有App卸载，则idfv的值会被重置，即再重装此Vender的App，idfv的值和之前不同。</p>
<h3 id="4、MAC地址"><a href="#4、MAC地址" class="headerlink" title="4、MAC地址"></a>4、MAC地址</h3><p>使用WiFi的mac地址来取代已经废弃了的uniqueIdentifier方法。具体可见:<br><a href="http://stackoverflow.com/questions/677530/how-can-i-programmatically-get-the-mac-address-of-an-iphone" target="_blank" rel="external">http://stackoverflow.com/questions/677530/how-can-i-programmatically-get-the-mac-address-of-an-iphone</a></p>
<p>然而在iOS 7中苹果再一次无情的封杀mac地址，使用之前的方法获取到的mac地址全部都变成了02:00:00:00:00:00。</p>
<h3 id="5、Keychain"><a href="#5、Keychain" class="headerlink" title="5、Keychain"></a>5、Keychain</h3><p><img src="/img/277755-807a54b6dcbeb347.png" alt=""></p>
<p>我们可以获取到UUID，然后把UUID保存到KeyChain里面。</p>
<p>这样以后即使APP删了再装回来，也可以从KeyChain中读取回来。使用group还可以可以保证同一个开发商的所有程序针对同一台设备能够获取到相同的不变的UDID。</p>
<p>但是刷机或重装系统后uuid还是会改变。</p>
<p>把下面两个类文件放到你的项目中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">KeychainItemWrapper.h文件</div><div class="line">********************************</div><div class="line"></div><div class="line">#import &lt;UIKit/UIKit.h&gt;</div><div class="line"></div><div class="line">@interface KeychainItemWrapper : NSObject</div><div class="line">&#123;</div><div class="line">    NSMutableDictionary *keychainItemData;        // The actual keychain item data backing store.</div><div class="line">    NSMutableDictionary *genericPasswordQuery;    // A placeholder for the generic keychain item query used to locate the item.</div><div class="line">&#125;</div><div class="line"></div><div class="line">@property (nonatomic, retain) NSMutableDictionary *keychainItemData;</div><div class="line">@property (nonatomic, retain) NSMutableDictionary *genericPasswordQuery;</div><div class="line"></div><div class="line">// Designated initializer.</div><div class="line">- (id)initWithAccount:(NSString *)account service:(NSString *)service accessGroup:(NSString *) accessGroup;</div><div class="line"></div><div class="line">- (id)initWithIdentifier: (NSString *)identifier accessGroup:(NSString *) accessGroup;</div><div class="line">- (void)setObject:(id)inObject forKey:(id)key;</div><div class="line">- (id)objectForKey:(id)key;</div><div class="line"></div><div class="line">// Initializes and resets the default generic keychain item data.</div><div class="line">- (void)resetKeychainItem;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div></pre></td><td class="code"><pre><div class="line">KeychainItemWrapper.h文件</div><div class="line">********************************</div><div class="line"></div><div class="line">#import &quot;KeychainItemWrapper.h&quot;</div><div class="line">#import &lt;Security/Security.h&gt;</div><div class="line"></div><div class="line">/*</div><div class="line"></div><div class="line">These are the default constants and their respective types,</div><div class="line">available for the kSecClassGenericPassword Keychain Item class:</div><div class="line"></div><div class="line">kSecAttrAccessGroup            -        CFStringRef</div><div class="line">kSecAttrCreationDate        -        CFDateRef</div><div class="line">kSecAttrModificationDate    -        CFDateRef</div><div class="line">kSecAttrDescription            -        CFStringRef</div><div class="line">kSecAttrComment                -        CFStringRef</div><div class="line">kSecAttrCreator                -        CFNumberRef</div><div class="line">kSecAttrType                -        CFNumberRef</div><div class="line">kSecAttrLabel                -        CFStringRef</div><div class="line">kSecAttrIsInvisible            -        CFBooleanRef</div><div class="line">kSecAttrIsNegative            -        CFBooleanRef</div><div class="line">kSecAttrAccount                -        CFStringRef</div><div class="line">kSecAttrService                -        CFStringRef</div><div class="line">kSecAttrGeneric                -        CFDataRef</div><div class="line"></div><div class="line">See the header file Security/SecItem.h for more details.</div><div class="line"></div><div class="line">*/</div><div class="line"></div><div class="line">@interface KeychainItemWrapper (PrivateMethods)</div><div class="line">/*</div><div class="line">The decision behind the following two methods (secItemFormatToDictionary and dictionaryToSecItemFormat) was</div><div class="line">to encapsulate the transition between what the detail view controller was expecting (NSString *) and what the</div><div class="line">Keychain API expects as a validly constructed container class.</div><div class="line">*/</div><div class="line">- (NSMutableDictionary *)secItemFormatToDictionary:(NSDictionary *)dictionaryToConvert;</div><div class="line">- (NSMutableDictionary *)dictionaryToSecItemFormat:(NSDictionary *)dictionaryToConvert;</div><div class="line"></div><div class="line">// Updates the item in the keychain, or adds it if it doesn&apos;t exist.</div><div class="line">- (void)writeToKeychain;</div><div class="line"></div><div class="line">@end</div><div class="line"></div><div class="line">@implementation KeychainItemWrapper</div><div class="line"></div><div class="line">@synthesize keychainItemData, genericPasswordQuery;</div><div class="line"></div><div class="line">- (id)initWithAccount:(NSString *)account service:(NSString *)service accessGroup:(NSString *) accessGroup;</div><div class="line">&#123;</div><div class="line">    if (self = [super init])</div><div class="line">    &#123;</div><div class="line">        NSAssert(account != nil || service != nil, @&quot;Both account and service are nil.  Must specifiy at least one.&quot;);</div><div class="line">        // Begin Keychain search setup. The genericPasswordQuery the attributes kSecAttrAccount and</div><div class="line">        // kSecAttrService are used as unique identifiers differentiating keychain items from one another</div><div class="line">        genericPasswordQuery = [[NSMutableDictionary alloc] init];</div><div class="line"></div><div class="line">        [genericPasswordQuery setObject:(id)kSecClassGenericPassword forKey:(id)kSecClass];</div><div class="line"></div><div class="line">        [genericPasswordQuery setObject:account forKey:(id)kSecAttrAccount];</div><div class="line">        [genericPasswordQuery setObject:service forKey:(id)kSecAttrService];</div><div class="line"></div><div class="line">        // The keychain access group attribute determines if this item can be shared</div><div class="line">        // amongst multiple apps whose code signing entitlements contain the same keychain access group.</div><div class="line">        if (accessGroup != nil)</div><div class="line">        &#123;</div><div class="line">#if TARGET_IPHONE_SIMULATOR</div><div class="line">            // Ignore the access group if running on the iPhone simulator.</div><div class="line">            //</div><div class="line">            // Apps that are built for the simulator aren&apos;t signed, so there&apos;s no keychain access group</div><div class="line">            // for the simulator to check. This means that all apps can see all keychain items when run</div><div class="line">            // on the simulator.</div><div class="line">            //</div><div class="line">            // If a SecItem contains an access group attribute, SecItemAdd and SecItemUpdate on the</div><div class="line">            // simulator will return -25243 (errSecNoAccessForItem).</div><div class="line">#else</div><div class="line">            [genericPasswordQuery setObject:accessGroup forKey:(id)kSecAttrAccessGroup];</div><div class="line">#endif</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Use the proper search constants, return only the attributes of the first match.</div><div class="line">        [genericPasswordQuery setObject:(id)kSecMatchLimitOne forKey:(id)kSecMatchLimit];</div><div class="line">        [genericPasswordQuery setObject:(id)kCFBooleanTrue forKey:(id)kSecReturnAttributes];</div><div class="line"></div><div class="line">        NSDictionary *tempQuery = [NSDictionary dictionaryWithDictionary:genericPasswordQuery];</div><div class="line"></div><div class="line">        NSMutableDictionary *outDictionary = nil;</div><div class="line"></div><div class="line">        if (! SecItemCopyMatching((CFDictionaryRef)tempQuery, (CFTypeRef *)&amp;outDictionary) == noErr)</div><div class="line">        &#123;</div><div class="line">            // Stick these default values into keychain item if nothing found.</div><div class="line">            [self resetKeychainItem];</div><div class="line"></div><div class="line">            //Adding the account and service identifiers to the keychain</div><div class="line">            [keychainItemData setObject:account forKey:(id)kSecAttrAccount];</div><div class="line">            [keychainItemData setObject:service forKey:(id)kSecAttrService];</div><div class="line"></div><div class="line">            if (accessGroup != nil)</div><div class="line">            &#123;</div><div class="line">#if TARGET_IPHONE_SIMULATOR</div><div class="line">                // Ignore the access group if running on the iPhone simulator.</div><div class="line">                //</div><div class="line">                // Apps that are built for the simulator aren&apos;t signed, so there&apos;s no keychain access group</div><div class="line">                // for the simulator to check. This means that all apps can see all keychain items when run</div><div class="line">                // on the simulator.</div><div class="line">                //</div><div class="line">                // If a SecItem contains an access group attribute, SecItemAdd and SecItemUpdate on the</div><div class="line">                // simulator will return -25243 (errSecNoAccessForItem).</div><div class="line">#else</div><div class="line">                [keychainItemData setObject:accessGroup forKey:(id)kSecAttrAccessGroup];</div><div class="line">#endif</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        else</div><div class="line">        &#123;</div><div class="line">            // load the saved data from Keychain.</div><div class="line">            self.keychainItemData = [self secItemFormatToDictionary:outDictionary];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        [outDictionary release];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return self;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (id)initWithIdentifier: (NSString *)identifier accessGroup:(NSString *) accessGroup;</div><div class="line">&#123;</div><div class="line">    if (self = [super init])</div><div class="line">    &#123;</div><div class="line">        // Begin Keychain search setup. The genericPasswordQuery leverages the special user</div><div class="line">        // defined attribute kSecAttrGeneric to distinguish itself between other generic Keychain</div><div class="line">        // items which may be included by the same application.</div><div class="line">        genericPasswordQuery = [[NSMutableDictionary alloc] init];</div><div class="line"></div><div class="line">        [genericPasswordQuery setObject:(id)kSecClassGenericPassword forKey:(id)kSecClass];</div><div class="line">        [genericPasswordQuery setObject:identifier forKey:(id)kSecAttrGeneric];</div><div class="line"></div><div class="line">        // The keychain access group attribute determines if this item can be shared</div><div class="line">        // amongst multiple apps whose code signing entitlements contain the same keychain access group.</div><div class="line">        if (accessGroup != nil)</div><div class="line">        &#123;</div><div class="line">#if TARGET_IPHONE_SIMULATOR</div><div class="line">            // Ignore the access group if running on the iPhone simulator.</div><div class="line">            // </div><div class="line">            // Apps that are built for the simulator aren&apos;t signed, so there&apos;s no keychain access group</div><div class="line">            // for the simulator to check. This means that all apps can see all keychain items when run</div><div class="line">            // on the simulator.</div><div class="line">            //</div><div class="line">            // If a SecItem contains an access group attribute, SecItemAdd and SecItemUpdate on the</div><div class="line">            // simulator will return -25243 (errSecNoAccessForItem).</div><div class="line">#else            </div><div class="line">            [genericPasswordQuery setObject:accessGroup forKey:(id)kSecAttrAccessGroup];</div><div class="line">#endif</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Use the proper search constants, return only the attributes of the first match.</div><div class="line">        [genericPasswordQuery setObject:(id)kSecMatchLimitOne forKey:(id)kSecMatchLimit];</div><div class="line">        [genericPasswordQuery setObject:(id)kCFBooleanTrue forKey:(id)kSecReturnAttributes];</div><div class="line"></div><div class="line">        NSDictionary *tempQuery = [NSDictionary dictionaryWithDictionary:genericPasswordQuery];</div><div class="line"></div><div class="line">        NSMutableDictionary *outDictionary = nil;</div><div class="line"></div><div class="line">        if (! SecItemCopyMatching((CFDictionaryRef)tempQuery, (CFTypeRef *)&amp;outDictionary) == noErr)</div><div class="line">        &#123;</div><div class="line">            // Stick these default values into keychain item if nothing found.</div><div class="line">            [self resetKeychainItem];</div><div class="line"></div><div class="line">            // Add the generic attribute and the keychain access group.</div><div class="line">            [keychainItemData setObject:identifier forKey:(id)kSecAttrGeneric];</div><div class="line">            if (accessGroup != nil)</div><div class="line">            &#123;</div><div class="line">#if TARGET_IPHONE_SIMULATOR</div><div class="line">                // Ignore the access group if running on the iPhone simulator.</div><div class="line">                // </div><div class="line">                // Apps that are built for the simulator aren&apos;t signed, so there&apos;s no keychain access group</div><div class="line">                // for the simulator to check. This means that all apps can see all keychain items when run</div><div class="line">                // on the simulator.</div><div class="line">                //</div><div class="line">                // If a SecItem contains an access group attribute, SecItemAdd and SecItemUpdate on the</div><div class="line">                // simulator will return -25243 (errSecNoAccessForItem).</div><div class="line">#else            </div><div class="line">                [keychainItemData setObject:accessGroup forKey:(id)kSecAttrAccessGroup];</div><div class="line">#endif</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        else</div><div class="line">        &#123;</div><div class="line">            // load the saved data from Keychain.</div><div class="line">            self.keychainItemData = [self secItemFormatToDictionary:outDictionary];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        [outDictionary release];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return self;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)dealloc</div><div class="line">&#123;</div><div class="line">    [keychainItemData release];</div><div class="line">    [genericPasswordQuery release];</div><div class="line"></div><div class="line">    [super dealloc];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)setObject:(id)inObject forKey:(id)key </div><div class="line">&#123;</div><div class="line">    if (inObject == nil) return;</div><div class="line">    id currentObject = [keychainItemData objectForKey:key];</div><div class="line">    if (![currentObject isEqual:inObject])</div><div class="line">    &#123;</div><div class="line">        [keychainItemData setObject:inObject forKey:key];</div><div class="line">        [self writeToKeychain];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (id)objectForKey:(id)key</div><div class="line">&#123;</div><div class="line">    return [keychainItemData objectForKey:key];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)resetKeychainItem</div><div class="line">&#123;</div><div class="line">    OSStatus junk = noErr;</div><div class="line">    if (!keychainItemData) </div><div class="line">    &#123;</div><div class="line">        self.keychainItemData = [[NSMutableDictionary alloc] init];</div><div class="line">    &#125;</div><div class="line">    else if (keychainItemData)</div><div class="line">    &#123;</div><div class="line">        NSMutableDictionary *tempDictionary = [self dictionaryToSecItemFormat:keychainItemData];</div><div class="line">        junk = SecItemDelete((CFDictionaryRef)tempDictionary);</div><div class="line">        NSAssert( junk == noErr || junk == errSecItemNotFound, @&quot;Problem deleting current dictionary.&quot; );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Default attributes for keychain item.</div><div class="line">    [keychainItemData setObject:@&quot;&quot; forKey:(id)kSecAttrAccount];</div><div class="line">    [keychainItemData setObject:@&quot;&quot; forKey:(id)kSecAttrLabel];</div><div class="line">    [keychainItemData setObject:@&quot;&quot; forKey:(id)kSecAttrDescription];</div><div class="line"></div><div class="line">    // Default data for keychain item.</div><div class="line">    [keychainItemData setObject:@&quot;&quot; forKey:(id)kSecValueData];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (NSMutableDictionary *)dictionaryToSecItemFormat:(NSDictionary *)dictionaryToConvert</div><div class="line">&#123;</div><div class="line">    // The assumption is that this method will be called with a properly populated dictionary</div><div class="line">    // containing all the right key/value pairs for a SecItem.</div><div class="line"></div><div class="line">    // Create a dictionary to return populated with the attributes and data.</div><div class="line">    NSMutableDictionary *returnDictionary = [NSMutableDictionary dictionaryWithDictionary:dictionaryToConvert];</div><div class="line"></div><div class="line">    // Add the Generic Password keychain item class attribute.</div><div class="line">    [returnDictionary setObject:(id)kSecClassGenericPassword forKey:(id)kSecClass];</div><div class="line"></div><div class="line">    // Convert the NSString to NSData to meet the requirements for the value type kSecValueData.</div><div class="line">    // This is where to store sensitive data that should be encrypted.</div><div class="line">    NSString *passwordString = [dictionaryToConvert objectForKey:(id)kSecValueData];</div><div class="line">    [returnDictionary setObject:[passwordString dataUsingEncoding:NSUTF8StringEncoding] forKey:(id)kSecValueData];</div><div class="line"></div><div class="line">    return returnDictionary;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (NSMutableDictionary *)secItemFormatToDictionary:(NSDictionary *)dictionaryToConvert</div><div class="line">&#123;</div><div class="line">    // The assumption is that this method will be called with a properly populated dictionary</div><div class="line">    // containing all the right key/value pairs for the UI element.</div><div class="line"></div><div class="line">    // Create a dictionary to return populated with the attributes and data.</div><div class="line">    NSMutableDictionary *returnDictionary = [NSMutableDictionary dictionaryWithDictionary:dictionaryToConvert];</div><div class="line"></div><div class="line">    // Add the proper search key and class attribute.</div><div class="line">    [returnDictionary setObject:(id)kCFBooleanTrue forKey:(id)kSecReturnData];</div><div class="line">    [returnDictionary setObject:(id)kSecClassGenericPassword forKey:(id)kSecClass];</div><div class="line"></div><div class="line">    // Acquire the password data from the attributes.</div><div class="line">    NSData *passwordData = NULL;</div><div class="line">    if (SecItemCopyMatching((CFDictionaryRef)returnDictionary, (CFTypeRef *)&amp;passwordData) == noErr)</div><div class="line">    &#123;</div><div class="line">        // Remove the search, class, and identifier key/value, we don&apos;t need them anymore.</div><div class="line">        [returnDictionary removeObjectForKey:(id)kSecReturnData];</div><div class="line"></div><div class="line">        // Add the password to the dictionary, converting from NSData to NSString.</div><div class="line">        NSString *password = [[[NSString alloc] initWithBytes:[passwordData bytes] length:[passwordData length] </div><div class="line">                                                     encoding:NSUTF8StringEncoding] autorelease];</div><div class="line">        [returnDictionary setObject:password forKey:(id)kSecValueData];</div><div class="line">    &#125;</div><div class="line">    else</div><div class="line">    &#123;</div><div class="line">        // Don&apos;t do anything if nothing is found.</div><div class="line">        NSAssert(NO, @&quot;Serious error, no matching item found in the keychain.\n&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    [passwordData release];</div><div class="line"></div><div class="line">    return returnDictionary;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)writeToKeychain</div><div class="line">&#123;</div><div class="line">    NSDictionary *attributes = NULL;</div><div class="line">    NSMutableDictionary *updateItem = NULL;</div><div class="line">    OSStatus result;</div><div class="line"></div><div class="line">    if (SecItemCopyMatching((CFDictionaryRef)genericPasswordQuery, (CFTypeRef *)&amp;attributes) == noErr)</div><div class="line">    &#123;</div><div class="line">        // First we need the attributes from the Keychain.</div><div class="line">        updateItem = [NSMutableDictionary dictionaryWithDictionary:attributes];</div><div class="line">        // Second we need to add the appropriate search key/values.</div><div class="line">        [updateItem setObject:[genericPasswordQuery objectForKey:(id)kSecClass] forKey:(id)kSecClass];</div><div class="line"></div><div class="line">        // Lastly, we need to set up the updated attribute list being careful to remove the class.</div><div class="line">        NSMutableDictionary *tempCheck = [self dictionaryToSecItemFormat:keychainItemData];</div><div class="line">        [tempCheck removeObjectForKey:(id)kSecClass];</div><div class="line"></div><div class="line">#if TARGET_IPHONE_SIMULATOR</div><div class="line">        // Remove the access group if running on the iPhone simulator.</div><div class="line">        // </div><div class="line">        // Apps that are built for the simulator aren&apos;t signed, so there&apos;s no keychain access group</div><div class="line">        // for the simulator to check. This means that all apps can see all keychain items when run</div><div class="line">        // on the simulator.</div><div class="line">        //</div><div class="line">        // If a SecItem contains an access group attribute, SecItemAdd and SecItemUpdate on the</div><div class="line">        // simulator will return -25243 (errSecNoAccessForItem).</div><div class="line">        //</div><div class="line">        // The access group attribute will be included in items returned by SecItemCopyMatching,</div><div class="line">        // which is why we need to remove it before updating the item.</div><div class="line">        [tempCheck removeObjectForKey:(id)kSecAttrAccessGroup];</div><div class="line">#endif</div><div class="line"></div><div class="line">        // An implicit assumption is that you can only update a single item at a time.</div><div class="line"></div><div class="line">        result = SecItemUpdate((CFDictionaryRef)updateItem, (CFDictionaryRef)tempCheck);</div><div class="line">        NSAssert( result == noErr, @&quot;Couldn&apos;t update the Keychain Item.&quot; );</div><div class="line">    &#125;</div><div class="line">    else</div><div class="line">    &#123;</div><div class="line">        // No previous item found; add the new one.</div><div class="line">        result = SecItemAdd((CFDictionaryRef)[self dictionaryToSecItemFormat:keychainItemData], NULL);</div><div class="line">        NSAssert( result == noErr, @&quot;Couldn&apos;t add the Keychain Item.&quot; );</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>我们在写一个工具类用来保存UUID到keychain和从keychain中读取UUID.</p>
<p><strong>实现代码</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">#pragma mark - 保存和读取UUID</div><div class="line">+(void)saveUUIDToKeyChain&#123;</div><div class="line">    KeychainItemWrapper *keychainItem = [[KeychainItemWrapper alloc] initWithAccount:@&quot;Identfier&quot; service:@&quot;AppName&quot; accessGroup:nil];</div><div class="line">    NSString *string = [keychainItem objectForKey: (__bridge id)kSecAttrGeneric];</div><div class="line">    if([string isEqualToString:@&quot;&quot;] || !string)&#123;</div><div class="line">        [keychainItem setObject:[self getUUIDString] forKey:(__bridge id)kSecAttrGeneric];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+(NSString *)readUUIDFromKeyChain&#123;</div><div class="line">    KeychainItemWrapper *keychainItemm = [[KeychainItemWrapper alloc] initWithAccount:@&quot;Identfier&quot; service:@&quot;AppName&quot; accessGroup:nil];</div><div class="line">    NSString *UUID = [keychainItemm objectForKey: (__bridge id)kSecAttrGeneric];</div><div class="line">    return UUID;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (NSString *)getUUIDString</div><div class="line">&#123;</div><div class="line">    CFUUIDRef uuidRef = CFUUIDCreate(kCFAllocatorDefault);</div><div class="line">    CFStringRef strRef = CFUUIDCreateString(kCFAllocatorDefault , uuidRef);</div><div class="line">    NSString *uuidString = [(__bridge NSString*)strRef stringByReplacingOccurrencesOfString:@&quot;-&quot; withString:@&quot;&quot;];</div><div class="line">    CFRelease(strRef);</div><div class="line">    CFRelease(uuidRef);</div><div class="line">    return uuidString;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>写入UUID到keychain</p>
<p>我们最好在程序启动之后把UUID写入到keychain，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions</div><div class="line">&#123;</div><div class="line">    [AppUtils saveUUIDToKeyChain];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>读取UUID</p>
<p>在需要读取的地方直接调用AppUtils的类方法readUUIDFromKeyChain即可。</p>
<hr>
<p>1.让同一开发商的所有APP在同一台设备上获取到UUID相同</p>
<p>在每个APP的项目里面做如下设置</p>
<p>1.1、设置accessgroup<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">keychainItemWrapper *keychainItem = [[KeychainItemWrapper alloc] initWithAccount:@&quot;Identfier&quot; service:@&quot;AppName&quot; accessGroup:@&quot;YOUR_BUNDLE_SEED.com.yourcompany.userinfo&quot;];</div></pre></td></tr></table></figure></p>
<p>1.2、创建plist文件</p>
<p>然后在项目相同的目录下创建KeychainAccessGroups.plist文件。</p>
<p>该文件的结构是一个字典，其中中最顶层的节点必须是一个键为“keychain-access-groups”的Array，并且该Array中每一项都是一个描述分组的NSString。YOUR_BUNDLE_SEED.com.yourcompany.userinfo就是要设置的组名。</p>
<p>如图:<br><img src="/img/277755-72008ba008a56557.png" alt=""><br>1.3、 设置code signing</p>
<p>接着在Target—&gt;Build Settings—-&gt;Code Signing栏下的Code Signing Entitlements右侧添加KeychainAccessGroups.plist</p>
<p>如图：<br><img src="/img/277755-e736892057d71333.png" alt=""></p>
<p>这样就可以保证每个app都是从keychain中读取出来同一个UUID</p>

  </section>
</article>

  <div class="sharing grid">
  <section class="profile grid-item grid">
    <img class="avatar" src="/images/avatar.png" alt="avatar" />
    <div class="grid-item">
      <p class="title"> Jason </p>
      <p class="subtitle"> iOS Developer </p>
    <div>
  </section>

  <section class="share-btns">
    <!-- <p> share it if you like it~ </p> -->
    <a
  class="twitter-share-button"
  data-size="large"
  data-via="DrakeLeung"
  href="https://twitter.com/intent/tweet?text=在开发过程中，我们经常会被要求获取每个设"
>
  Tweet
</a>

<script>
  window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  js.async = true;
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));
</script>

  </section>
</div>


  
    
<section class="article-comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

<script>
  var disqus_shortname = 'drakeleung';
  
  var disqus_url = 'http://yoursite.com/2017/04/21/获取iOS设备唯一标示UUID (转发)/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


  
</main>

</body>
</html>
